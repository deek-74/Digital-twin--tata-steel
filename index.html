<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Twin for Environmental Reporting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Digital Twin for enhancement of Environmental Reporting</h1>
            <p class="text-lg text-gray-600 mt-2">Upload environmental reports to generate an ESG score, summaries, and visualize key data.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Control Panel -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg space-y-6">
                <h2 class="text-2xl font-semibold mb-2 border-b pb-3">Control Panel</h2>
                
                <div>
                    <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">Your Google Gemini API Key</label>
                    <input type="password" id="apiKey" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter your API key here">
                </div>

                <div class="space-y-4">
                    <h3 class="font-semibold text-gray-800">Core Documents (for Analysis & Score)</h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">1. BRSR Report (PDF)</label>
                        <input type="file" id="brsrFile" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept=".pdf">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">2. Environmental Dataset (PDF)</label>
                        <input type="file" id="envDataFile" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept=".pdf">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">3. S&P MSA Methodology (PDF)</label>
                        <input type="file" id="msaFile" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" accept=".pdf">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">4. S&P CSA Methodology (PDF)</label>
                        <input type="file" id="csaFile" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" accept=".pdf">
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="font-semibold text-gray-800">Additional Reports (for Context & Summarization)</h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Upload one or more files (Optional)</label>
                        <input type="file" id="additionalFiles" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100" accept=".pdf" multiple>
                    </div>
                </div>


                <button id="analyzeBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center justify-center text-lg">
                    <i class="fas fa-cogs mr-2"></i> Generate Full Analysis
                </button>

                <div id="status" class="mt-4 text-center"></div>
            </div>

            <!-- Results & Dashboard -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <!-- Results Section -->
                <div id="resultsSection" class="hidden">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Analysis Results</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                        <div class="bg-blue-100 p-4 rounded-lg">
                            <h3 class="font-bold text-lg text-blue-800">ESG Score</h3>
                            <p id="esgScore" class="text-3xl font-bold text-blue-900 mt-1">--</p>
                        </div>
                         <div class="md:col-span-2 bg-green-100 p-4 rounded-lg text-left">
                            <h3 class="font-bold text-lg text-green-800">S&P Methodology Feedback</h3>
                            <div id="feedback" class="text-gray-700 mt-1 leading-relaxed">Awaiting analysis...</div>
                        </div>
                    </div>
                     <div class="flex flex-wrap gap-4 mb-6">
                         <button id="downloadExcelBtn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition duration-300 flex items-center justify-center">
                            <i class="fas fa-file-excel mr-2"></i> Download Extracted Data
                        </button>
                         <button id="downloadSummariesBtn" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition duration-300 flex items-center justify-center" disabled>
                            <i class="fas fa-file-alt mr-2"></i> Download Summaries
                        </button>
                     </div>
                </div>
               
                <!-- Summaries Section -->
                <div id="summariesSection" class="hidden mb-8">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Report Summaries & Key Takeaways</h2>
                    <div id="summariesContainer" class="space-y-4"></div>
                </div>

                <!-- Dashboard Section -->
                <div id="dashboardSection" class="hidden">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Visual Dashboard</h2>
                    <div id="chartsGrid" class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <!-- Charts will be injected here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        const fileInputs = {
            apiKey: document.getElementById('apiKey'),
            brsr: document.getElementById('brsrFile'),
            envData: document.getElementById('envDataFile'),
            msa: document.getElementById('msaFile'),
            csa: document.getElementById('csaFile'),
            additional: document.getElementById('additionalFiles')
        };
        const analyzeBtn = document.getElementById('analyzeBtn');
        const statusDiv = document.getElementById('status');
        const resultsSection = document.getElementById('resultsSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const chartsGrid = document.getElementById('chartsGrid');
        const summariesSection = document.getElementById('summariesSection');
        const summariesContainer = document.getElementById('summariesContainer');
        const esgScoreEl = document.getElementById('esgScore');
        const feedbackEl = document.getElementById('feedback');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn');
        const downloadSummariesBtn = document.getElementById('downloadSummariesBtn');
        
        let extractedData = null;
        let generatedSummaries = [];
        let activeCharts = {};

        analyzeBtn.addEventListener('click', async () => {
            const apiKey = fileInputs.apiKey.value.trim();
            const { brsr, envData, msa, csa, additional } = fileInputs;

            if (!apiKey || !brsr.files[0] || !msa.files[0] || !csa.files[0] || !envData.files[0]) {
                showStatus('Please provide API key and all four core documents.', 'error');
                return;
            }

            resetUI();

            try {
                showStatus('Reading and collecting all documents...', 'loading');
                
                const companyReportFiles = [brsr.files[0], envData.files[0], ...Array.from(additional.files)];
                const methodologyFiles = [msa.files[0], csa.files[0]];
                
                const allFiles = [...companyReportFiles, ...methodologyFiles];

                const textPromises = allFiles.map(file => file ? extractTextFromPdf(file).catch(e => {
                    console.error(`Failed to read ${file.name}:`, e);
                    return `Error reading file: ${file.name}`;
                }) : Promise.resolve(""));
                
                const allTexts = await Promise.all(textPromises);

                const companyReportsText = allTexts.slice(0, companyReportFiles.length).join('\n\n---\n\n');
                const msaText = allTexts[companyReportFiles.length];
                const csaText = allTexts[companyReportFiles.length + 1];

                const summaryPromises = companyReportFiles.map(file => 
                    file ? extractTextFromPdf(file)
                        .then(text => summarizeDocument(apiKey, text, file.name))
                        .then(summary => ({ filename: file.name, summary })) : Promise.resolve(null)
                ).filter(p => p);

                showStatus('Extracting key data with Gemini...', 'loading');
                const dataExtractionPromise = extractDataForDashboard(apiKey, companyReportsText);

                const [dataResult, summaryResults] = await Promise.all([dataExtractionPromise, Promise.all(summaryPromises)]);
                
                extractedData = dataResult;

                showStatus('Generating ESG score and feedback...', 'loading');
                const esgResult = await generateEsgScore(apiKey, JSON.stringify(extractedData, null, 2), companyReportsText, msaText, csaText);

                showStatus('Analysis Complete!', 'success');
                generatedSummaries = summaryResults;
                displayResults(esgResult);
                displaySummaries(summaryResults);
                renderFullDashboard();
                
            } catch (error) {
                console.error('Analysis failed:', error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        });

        async function callGemini(apiKey, prompt, isJson = false) {
            const model = 'gemini-1.5-flash-latest';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { temperature: 0.2, topP: 0.95 }
            };
            if(isJson) {
                payload.generationConfig.responseMimeType = "application/json";
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API call failed with status ${response.status}: ${errorBody}`);
            }

            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                 return result.candidates[0].content.parts[0].text;
            } else if (result.promptFeedback?.blockReason) {
                throw new Error(`Request blocked by API. Reason: ${result.promptFeedback.blockReason}`);
            } else {
                 throw new Error('Invalid response from Gemini API. Check API key or prompt.');
            }
        }
        
        async function extractDataForDashboard(apiKey, allCompanyReportsText) {
            const prompt = `
            As an expert ESG data analyst, extract key metrics from the combined text of all provided corporate reports.
            Your primary goal is to find quantitative, time-series data for these specific metrics:

            1.  **TotalGHGEmissions**: { years: string[], scope1: number[], scope2: number[] } (Find Scope 1 and Scope 2 emissions in 'Million tCO2e'. Combine them for a total.)
            2.  **GHGEmissionIntensity**: { years: string[], intensity: number[] } (Find 'GHG Intensity' or 'Emission intensity' in 'tCO2e/tonne crude steel' or 'kg/tcs'. If in kg/tcs, convert to tCO2e/tcs by dividing by 1000).
            3.  **FreshWaterConsumption**: { years: string[], consumption: number[] } (Find 'Fresh water consumption' or 'Specific fresh water consumption' in 'Million m3' or 'm3/tcs').
            4.  **SolidWasteUtilisationRate**: { years: string[], rate: number[] } (Find 'Solid waste utilisation' as a percentage '%').
            5.  **AirPollutantEmissions**: { years: string[], stackDust: number[], sox: number[], nox: number[] } (Find 'Stack dust emissions', 'Stack SOx emissions', 'Stack NOx emissions' in 'Thousand tonnes').
            6.  **BiodiversityManagementArea**: { years: string[], area: number[] } (Find 'Total area covered under Biodiversity Management Plans (BMPs)' in 'Hectares').

            Carefully scan all provided text to find tables and statements containing this data. Match the years correctly. If a metric is not found, omit its entire object from the JSON. Be precise.

            Combined Reports Text:
            ---
            ${allCompanyReportsText.substring(0, 150000)}
            ---
            Return ONLY a single, valid JSON object. Do not include any explanatory text.`;
            const jsonString = await callGemini(apiKey, prompt, true);
            try {
                const cleanedJsonString = jsonString.replace(/^```json\n/, '').replace(/\n```$/, '');
                return JSON.parse(cleanedJsonString);
            } catch (e) {
                console.error("Failed to parse JSON from Gemini:", jsonString);
                throw new Error("The AI failed to return valid JSON for data extraction. The source documents might lack clear data tables.");
            }
        }
        
        async function generateEsgScore(apiKey, extractedJson, allCompanyReportsText, msaText, csaText) {
             const prompt = `You are a positive and constructive ESG consultant providing feedback for a corporate presentation. Your goal is to be honest but encouraging.

            **Instructions:**
            1.  **Analyze Data:** Scrutinize the provided quantitative (JSON) and qualitative (full text) data.
            2.  **Apply S&P Methodology:** Use the S&P MSA/CSA texts as your framework.
            3.  **Generate Score:** Provide a numerical ESG score out of 100.
            4.  **Provide Feedback as a Concise Bulleted List:**
                * **Start with Strengths:** Begin with a bullet point praising strengths (e.g., Net Zero commitment, circular economy).
                * **Frame Gaps as Opportunities:** Use bullet points to frame data gaps as "Opportunities for enhanced disclosure" (e.g., detailing multi-year environmental trends).
                * **Suggest Improvements Constructively:** Use a bullet point to suggest improvements, for instance, "Opportunity to demonstrate industry leadership by enhancing safety programs towards a zero-harm workplace."
                * **Keep the entire feedback to 3-4 bullet points maximum.**

            **Extracted Quantitative Data (JSON):**
            ---
            ${extractedJson}
            ---
            **Full Text from All Company Reports (for qualitative context):**
            ---
            ${allCompanyReportsText.substring(0, 50000)}
            ---
            **S&P MSA & CSA Methodologies:**
            ---
            ${msaText.substring(0, 15000)}
            ${csaText.substring(0, 15000)}
            ---
            Return ONLY a single, valid JSON object with two keys: "esgScore" (a number) and "feedback" (a string containing a bulleted list).`;
            const jsonString = await callGemini(apiKey, prompt, true);
             try {
                return JSON.parse(jsonString);
            } catch (e) {
                console.error("Failed to parse JSON from Gemini for scoring:", jsonString);
                throw new Error("The AI failed to return valid JSON for the ESG score. Please try again.");
            }
        }

        async function summarizeDocument(apiKey, docText, filename) {
            const prompt = `Create a structured summary for the report "${filename}". 
            
            **Format:**
            1.  **Executive Summary:** A concise 1-2 paragraph overview.
            2.  **Key Takeaways:** A bulleted list using the '-' character.
            
            Focus on quantitative results, future commitments, and identified risks. Do not use any markdown for bolding (no asterisks).
            
            Report Text:
            ---
            ${docText.substring(0, 50000)}
            ---`;
            return await callGemini(apiKey, prompt);
        }

        function formatTextToHtmlList(text) {
            if (!text) return '';
            text = text.replace(/\*\*/g, '');

            const lines = text.split('\n').filter(line => line.trim() !== '');
            let html = '';
            let inList = false;

            lines.forEach(line => {
                if (line.trim().startsWith('* ') || line.trim().startsWith('- ') || line.trim().startsWith('â€¢ ')) {
                    if (!inList) {
                        html += '<ul class="list-disc list-inside space-y-1 mt-2">';
                        inList = true;
                    }
                    html += `<li>${line.trim().substring(2)}</li>`;
                } else {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    html += `<p class="mt-2 font-semibold">${line}</p>`;
                }
            });

            if (inList) {
                html += '</ul>';
            }
            return html;
        }


        function displayResults(result) {
            esgScoreEl.textContent = result.esgScore ?? 'N/A';
            feedbackEl.innerHTML = formatTextToHtmlList(result.feedback) || 'No feedback generated.';
            resultsSection.classList.remove('hidden');
        }

        function displaySummaries(summaries) {
            if (summaries.length === 0) return;
            summariesContainer.innerHTML = '';
            summaries.forEach(({ filename, summary }) => {
                const summaryCard = document.createElement('div');
                summaryCard.className = 'bg-gray-50 p-4 rounded-lg border';
                summaryCard.innerHTML = `
                    <h4 class="font-bold text-gray-700">${filename}</h4>
                    <div class="text-gray-600 mt-2 leading-relaxed">${formatTextToHtmlList(summary)}</div>
                `;
                summariesContainer.appendChild(summaryCard);
            });
            summariesSection.classList.remove('hidden');
            downloadSummariesBtn.disabled = false;
        }

        function resetUI() {
            resultsSection.classList.add('hidden');
            dashboardSection.classList.add('hidden');
            summariesSection.classList.add('hidden');
            summariesContainer.innerHTML = '';
            chartsGrid.innerHTML = '';
            downloadSummariesBtn.disabled = true;
            Object.values(activeCharts).forEach(chart => chart.destroy());
            activeCharts = {};
            extractedData = null;
            generatedSummaries = [];
        }
        
        function showStatus(message, type = 'info') {
            statusDiv.innerHTML = '';
            const p = document.createElement('p');
            p.textContent = message;

            if (type === 'loading') {
                const loader = document.createElement('div');
                loader.className = 'loader mx-auto my-2';
                statusDiv.appendChild(loader);
                p.className = 'text-blue-600';
            } else if (type === 'success') {
                p.className = 'text-green-600 font-semibold';
            } else if (type === 'error') {
                p.className = 'text-red-600 font-semibold';
            }
            statusDiv.appendChild(p);
        }

        async function extractTextFromPdf(file) {
            if (!file) return "";
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let allText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                allText += textContent.items.map(item => item.str).join(' ');
            }
            return allText;
        }

        downloadExcelBtn.addEventListener('click', () => {
            if (!extractedData) return alert('No data to export.');
            
            const flattenedData = [];
            const flattenObject = (obj, prefix = '') => {
                Object.keys(obj).forEach(key => {
                    const pre = prefix.length ? prefix + '.' : '';
                    if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
                        flattenObject(obj[key], pre + key);
                    } else {
                        flattenedData.push({
                            'Metric': pre + key,
                            'Value': Array.isArray(obj[key]) ? obj[key].join(', ') : obj[key]
                        });
                    }
                });
            };
            flattenObject(extractedData);

            const worksheet = XLSX.utils.json_to_sheet(flattenedData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Extracted Data');
            XLSX.writeFile(workbook, 'Extracted_ESG_Data.xlsx');
        });

        downloadSummariesBtn.addEventListener('click', () => {
            if (generatedSummaries.length === 0) return alert('No summaries to export.');
            const worksheets = {};
            generatedSummaries.forEach(s => {
                const cleanSummary = s.summary.replace(/<p>.*?<\/p>/g, '')
                                              .replace(/<ul class=".*?">/g, '')
                                              .replace(/<\/ul>/g, '')
                                              .replace(/<li>/g, '\n* ')
                                              .replace(/<\/li>/g, '')
                                              .replace(/<br>/g, '\n');
                
                const sheetName = s.filename.replace('.pdf', '').substring(0, 31);
                if (!worksheets[sheetName]) {
                    worksheets[sheetName] = [{ Summary: cleanSummary }];
                }
            });
            const workbook = XLSX.utils.book_new();
            for(const sheetName in worksheets) {
                const worksheet = XLSX.utils.json_to_sheet(worksheets[sheetName]);
                XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
            }
            XLSX.writeFile(workbook, 'Report_Summaries.xlsx');
        });

        function renderFullDashboard() {
            if (!extractedData || Object.keys(extractedData).length === 0) {
                 dashboardSection.classList.add('hidden');
                 return;
            };
            
            dashboardSection.classList.remove('hidden');
            const colors = {
                blue: 'rgba(54, 162, 235, 0.7)', green: 'rgba(75, 192, 192, 0.7)', 
                red: 'rgba(255, 99, 132, 0.7)', yellow: 'rgba(255, 206, 86, 0.7)',
                purple: 'rgba(153, 102, 255, 0.7)', orange: 'rgba(255, 159, 64, 0.7)',
                grey: 'rgba(201, 203, 207, 0.7)'
            };
            
            let chartRendered = false;

            if (extractedData.TotalGHGEmissions?.years) {
                const ghg = extractedData.TotalGHGEmissions;
                createChartContainer('ghgChart');
                renderChart('ghgChart', 'bar', ghg.years, [
                    { label: 'Scope 1', data: ghg.scope1, backgroundColor: colors.red, stack: 'Stack 0' },
                    { label: 'Scope 2', data: ghg.scope2, backgroundColor: colors.orange, stack: 'Stack 0' },
                ], 'Total GHG Emissions (Scope 1 & 2)', true);
                chartRendered = true;
            }

            if (extractedData.GHGEmissionIntensity?.years) {
                const ghgIntensity = extractedData.GHGEmissionIntensity;
                createChartContainer('ghgIntensityChart');
                renderChart('ghgIntensityChart', 'line', ghgIntensity.years, [
                    { label: 'GHG Intensity', data: ghgIntensity.intensity, borderColor: colors.purple, pointBackgroundColor: colors.purple, fill: false },
                ], 'GHG Emission Intensity (tCO2e/tcs)');
                chartRendered = true;
            }

            if (extractedData.FreshWaterConsumption?.years) {
                const water = extractedData.FreshWaterConsumption;
                createChartContainer('waterChart');
                renderChart('waterChart', 'bar', water.years, [
                    { label: 'Fresh Water Consumption', data: water.consumption, backgroundColor: colors.blue },
                ], 'Fresh Water Consumption');
                chartRendered = true;
            }

            if (extractedData.SolidWasteUtilisationRate?.years) {
                const waste = extractedData.SolidWasteUtilisationRate;
                createChartContainer('wasteUtilisationChart');
                renderChart('wasteUtilisationChart', 'bar', waste.years, [
                    { label: 'Utilisation Rate', data: waste.rate, backgroundColor: colors.green },
                ], 'Solid Waste Utilisation Rate (%)');
                chartRendered = true;
            }

            if (extractedData.AirPollutantEmissions?.years) {
                const air = extractedData.AirPollutantEmissions;
                createChartContainer('airPollutantsChart');
                renderChart('airPollutantsChart', 'line', air.years, [
                    { label: 'Stack Dust', data: air.stackDust, borderColor: colors.grey, pointBackgroundColor: colors.grey, fill: false },
                    { label: 'SOx', data: air.sox, borderColor: colors.yellow, pointBackgroundColor: colors.yellow, fill: false },
                    { label: 'NOx', data: air.nox, borderColor: colors.red, pointBackgroundColor: colors.red, fill: false }
                ], 'Air Pollutant Emissions (Thousand Tonnes)');
                chartRendered = true;
            }

            if (extractedData.BiodiversityManagementArea?.years) {
                 const bio = extractedData.BiodiversityManagementArea;
                 createChartContainer('biodiversityChart');
                 renderChart('biodiversityChart', 'line', bio.years, [{
                     label: 'Area',
                     data: bio.area,
                     borderColor: colors.green,
                     backgroundColor: 'rgba(75, 192, 192, 0.2)',
                     pointBackgroundColor: colors.green,
                     fill: true
                 }], 'Area Under Biodiversity Management Plans (Hectares)');
                chartRendered = true;
            }

            if (!chartRendered) {
                chartsGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full">Could not find sufficient quantitative data in the documents to generate the requested charts.</p>';
            }
        }

        function createChartContainer(canvasId) {
            const container = document.createElement('div');
            container.className = 'chart-container bg-gray-50 p-4 rounded-lg border';
            const canvas = document.createElement('canvas');
            canvas.id = canvasId;
            container.appendChild(canvas);
            chartsGrid.appendChild(container);
        }
        
        function renderChart(canvasId, type, labels, datasets, title, stacked = false) {
            if (activeCharts[canvasId]) activeCharts[canvasId].destroy();
            
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: title, font: { size: 16 } }
                },
                scales: {}
            };

            if (['bar', 'line'].includes(type)) {
                options.scales = { 
                    y: { beginAtZero: true, stacked: stacked },
                    x: { stacked: stacked }
                };
            }
            
            activeCharts[canvasId] = new Chart(ctx, {
                type: type,
                data: { labels: labels, datasets: datasets },
                options: options
            });
        }
    </script>
</body>
</html>

